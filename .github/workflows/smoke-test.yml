name: CD - Smoke Test

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Wait for Streamlit deployment
      run: |
        echo "â³ Waiting 120 seconds for Streamlit Cloud to deploy..."
        sleep 120
    
    - name: Health check - Main page
      run: |
        echo "ğŸ¥ Checking main application health..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://vit-carpool-by-satya.streamlit.app/)
        
        if [ $response -eq 200 ]; then
          echo "âœ… Main page is healthy (HTTP $response)"
        else
          echo "âŒ Main page returned HTTP $response"
          exit 1
        fi
    
    - name: Content validation
      run: |
        echo "ğŸ” Validating page content..."
        content=$(curl -s https://vit-carpool-by-satya.streamlit.app/)
        
        # Check for common error indicators
        if echo "$content" | grep -qi "error\|exception\|traceback"; then
          echo "âš ï¸ Warning: Error-related text detected in page content"
          echo "$content" | grep -i "error\|exception\|traceback" || true
        else
          echo "âœ… No obvious errors detected in page content"
        fi
    
    - name: Deployment summary
      if: always()
      run: |
        echo "ğŸš€ Smoke test completed"
        echo "ğŸŒ Live app: https://vit-carpool-by-satya.streamlit.app/"
